name: Run Reftests and Deploy to Pages

on:
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # Build job that runs on different platforms
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            platform: linux
          - os: macos-latest
            platform: macos
          - os: windows-latest
            platform: windows
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v3

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
    
      # Run reftests only on Linux
      - name: Setup Chrome (Linux only)
        if: matrix.os == 'ubuntu-latest'
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: 120
          install-dependencies: true

      - name: Check Chrome Installation (Linux only)
        if: matrix.os == 'ubuntu-latest'
        run: chrome --version

      - name: Run Reftests (Linux only)
        if: matrix.os == 'ubuntu-latest'
        run: cargo run --manifest-path doc/Cargo.toml --release -- --reftest

      # Build for each platform
      - name: Build for ${{ matrix.platform }}
        run: cargo run --manifest-path doc/Cargo.toml --release -- --build=${{ matrix.platform }}

      # Upload platform-specific artifacts
      - name: Upload ${{ matrix.platform }} artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deploy-${{ matrix.platform }}
          path: 'doc/target/deploy'

  # Merge artifacts from all platforms
  merge-artifacts:
    runs-on: ubuntu-latest
    needs: build
    steps:
      # Download all platform artifacts
      - name: Download Linux artifacts
        uses: actions/download-artifact@v3
        with:
          name: deploy-linux
          path: merged-artifacts

      - name: Download macOS artifacts
        uses: actions/download-artifact@v3
        with:
          name: deploy-macos
          path: temp-macos

      - name: Download Windows artifacts
        uses: actions/download-artifact@v3
        with:
          name: deploy-windows
          path: temp-windows

      # Merge artifacts, preserving platform-specific binaries
      - name: Merge artifacts
        run: |
          # Use cp -r for MacOS files
          cp -r temp-macos/* merged-artifacts/
          # Use cp -r for Windows files
          cp -r temp-windows/* merged-artifacts/
          
          # List contents to verify merge
          echo "Merged artifact contents:"
          find merged-artifacts -type f | sort

      # Prepare for GitHub Pages deployment
      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload merged artifacts for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'merged-artifacts'

  # Deploy merged artifacts to GitHub Pages
  deploy:
    environment:
      name: github-pages
    runs-on: ubuntu-latest
    needs: merge-artifacts
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4