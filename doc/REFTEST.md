# How to Debug Failing Reftests

This guide explains how to use the `reftest-headless` command to debug rendering tests in the Azul GUI framework.

## 1. Introduction

A "reftest" (reference test) works by comparing the output of Azul's rendering engine against a "golden" reference image generated by a standard web browser (Google Chrome). If the two images differ by more than a small threshold, the test fails.

Your goal is to use the provided tools to diagnose why Azul's rendering does not match the reference.

## 2. Prerequisites

Ensure the following are installed in your environment:
- `cargo` (The Rust build tool)
- `Google Chrome` (or Chromium)

## 3. The Debugging Workflow

### Step 1: Identify the Failing Test

You will be given the name of a failing test. The name corresponds to a test file in the `doc/src/reftest/working/` directory. For example, a test named `grid-span-2` corresponds to the file `grid-span-2.xht`.

### Step 2: Run the Headless Reftest Command

Navigate to the `doc` directory of the repository and execute the following command, replacing `<test_name>` with the name of the test you are debugging:

```bash
cargo run -- reftest-headless <test_name>
```

**Example:**

To debug the `grid-span-2` test, run:

```bash
cargo run -- reftest-headless grid-span-2
```

This command will run the specific test, generate fresh renderings from both Chrome and Azul, compare them, and print a comprehensive debug report to the console.

### Step 3: Analyze the Command Output

The output is divided into two main sections.

#### A. Comparison Result

This section gives you a quick summary of the test outcome.

```
--- COMPARISON RESULT ---
Test Name: grid-span-2
Result: FAILED
Differing Pixels: 54321
-------------------------
```

- **Result**: `PASSED` or `FAILED`.
- **Differing Pixels**: The number of pixels that are different between the Azul and Chrome renderings. A high number indicates a significant discrepancy.

#### B. Debug Information

This is the core section for your analysis. It provides a step-by-step breakdown of how Azul processed the test file.

```
--- DEBUG INFORMATION ---
# Test Metadata
Title: Grid with column-span: 2
Assert: The second item should span two columns.
...

# XHTML Source
... (The original .xht file content) ...

# CSS Warnings
... (Any warnings or errors found during CSS parsing) ...

# Parsed XML
... (The raw XML tree as interpreted by Azul's parser) ...

# Styled DOM
... (The DOM tree after CSS styles have been applied to each node) ...

# Solved Layout
... (High-level information from the layout engine) ...

# Display List
... (The final, low-level drawing commands sent to the renderer) ...

# Rendering Information
... (Timings and any warnings from the final rendering step) ...
--- END DEBUG INFORMATION ---
```

### Step 4: The Debugging Process

Follow this methodical approach to find the root cause of the failure:

1.  **Start with the Source**: Examine the **XHTML Source** and especially the **CSS Warnings**. An invalid style or syntax error in the CSS is a common cause of rendering issues.

2.  **Check the Parser**: Compare the **Parsed XML** to the **XHTML Source**. Did Azul's parser correctly understand the structure of the document? Mismatches here point to a bug in the XML parser.

3.  **Verify Styling**: This is the most critical step for CSS bugs. Scrutinize the **Styled DOM**. This section shows which CSS properties were applied to each DOM node.
    -   Are the expected CSS rules present?
    -   Are the property values correct?
    -   Is there a specificity issue where an incorrect rule is overriding the correct one?
    -   If the styles here are wrong, the issue is likely in the CSS parser or the style cascade logic.

4.  **Inspect the Layout Engine's Output**: If the **Styled DOM** looks correct, examine the **Display List**. This is the final set of drawing primitives (rectangles, text, borders) generated by the layout engine.
    -   Are the positions (`rect: Rect(...)`) and sizes correct?
    -   Are the colors and other properties what you'd expect based on the styles?
    -   If the `Styled DOM` is correct but the `Display List` is wrong, the bug is in the layout engine (`azul-layout`).

5.  **Visual Context**: The command saves two images to the `doc/target/reftest_headless/` directory: `<test_name>_chrome.webp` (the reference) and `<test_name>_azul.webp` (the actual output). If you can view these images, they will provide immediate visual context for the pixel difference count and the final rendering state.
